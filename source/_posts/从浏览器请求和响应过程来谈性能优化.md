---
title: 从浏览器请求和响应过程来谈性能优化
date: 2018-05-29 08:52:08
tags: 性能优化
categories: 换个角度看性能优化
---
## 小结于
>  网络

<!-- more -->
- 为什么前端性能如此重要？数据显示：
  
   - 只有10%~20%的最终用户响应时间用来下载HTML文档，其余80%~90%时间用在下载页面中的所有组件
   - 优化后台成本大，优化前端只需要适当遵循一些法则就会有较大的提升，低成本高收益

- 浏览器请求和响应过程

![浏览器请求和响应过程](https://img-blog.csdn.net/20160420123537079)


## 浏览器预处理

  - 查询Cache：读取Cache或者发送304 请求

## 查询DNS
> DNS查找就是输入域名对服务器IP地址的查找过程。   
> DNS缓存: 浏览器DNS缓存、操作系统DNS缓存。
>当你输入www.google.com的时候，浏览器会先去自身的 `DNS缓存` 里面查找有没有google服务器的IP地址;如果找不到则继续到 `操作系统的DNS缓存` 查找;如果浏览器在这两个容器都没有找到google的IP地址记录，则会向广域域名体系查找。

 ### ` 1. 优化规则 - 减少DNS查找`

 - 方法1：使用DNS缓存   
    浏览器DNS缓存 | 计算机DNS缓存 | 服务器DNS缓存（TTL）

- 方法2：使用Keep-Alive特性   
    当客户端的DNS缓存为空时，DNS查找的数量与Web页面中唯一主机名的数量相等。减少唯一主机名的数量就可以减少DNS查找的数量。

- 方法3：较少的域名来减少DNS查找（2-4个主机）

- 方法4：使用第三方DNS域名解析加速服务   
    国内的一款免费DNS加速服务DNSPOD；

## 建立连接
> CDN是一组分布在多个不同地理位置的Web服务器，由于距离用户 物理距离比较短，所以能够更加有利于用户获取到静态资源；这种服务通常需要购买，也有一些免费、通用的CDN可使用，国内的可以使用BootCDN。

### `2. 优化规则 – 使用内容分发网络（CDN） `  
  - 方法1：美国十大Internet网站和CDN服务提供商

  - 方法2：页面静态化,取决于发布系统

  - 方法3：Ctrip使用的China-Cache和网宿

### `3. 优化规则 – 用域名划分页面内容 `   
  
  按页面内容划分域名，在合适的资源服务器上存放文件

## 发送请求

>一般来说，使用外链的脚本和样式表更加有利。分别把外链脚本和样式表进行合并会减少HTTP请求，以节省客户端和服务器之间的通讯次数来加快页面打开速度。但是出于开发的便利，开发的时候一般会采取模块化的方式；这时候可以在部署前采用一些前端构建工具 `gulp` 、`grunt` 把这些模块文件合并起来再发布。
  
### `4. 优化规则 – 减少HTTP请求 `
  
  - 图片地图 
    
    - 假设导航栏上有五幅图片，点击每张图片都会进入一个链接，这样五张导航的图片在加载时会产生5个HTTP请求。然而，使用一个图片地图可以提高效率，这样就只需要一个HTTP请求。    
    
    ![](https://images2015.cnblogs.com/blog/861963/201603/861963-20160317164616318-1916945778.png)

    - 服务器端图片地图：将所有点击提交到同一个url，同时提交用户点击的x、y坐标，服务器端根据坐标映射响应
    - 客户端图片地图：直接将点击映射到操作
  - 内联图像    

  - 合并文件: js文件不超过7个,css文件不超过4个,各频道首页和全站首页不超过3个;
  - 目前无法解决的是allyes广告的请求数。 
  - 大量的广告和产品图片可能会造成，图片请求数很大，可能造成总请求数指标吃紧，这个只能从设计上搞定，需要权衡 
  - 目前老页面可能css和js文件请求数可能会超标  

  - 合并样式和脚本

### `5. 优化规则 – 优化CSS Spirite(图片精灵)` 
    
一种网页图片应用处理方式。允许你将一个页面涉及到的所有零星图片都包含到一张大图中去，再利用CSS的以下属性精确的定位出背景图片的位置。
>background-image  
background- repeat  
background-position 

    

### `6. 优化规则 – 避免404错误 `
  
  HTTP请求很昂贵，因此提出HTTP请求并获得无用的响应（即404 Not Found）是完全没有必要的，会减慢用户体验没有任何好处。  
  
  有些网站有帮助的404“你的意思是X？”，这对用户体验很好，但也浪费了服务器资源（如数据库等）。  
  
  特别糟糕的是，当到外部JavaScript的链接错误并且结果是404时。首先，此下载将阻止并行下载。接下来，浏览器可能会尝试解析404响应正文，就好像它是JavaScript代码一样，试图找到可用的东西。

### `7. 优化规则 – 不要使用frameset,少使用iframe`
  
  搜索引擎不友好，即使内容为空，加载也需要时间、会阻止页面加载 

  Iframe允许将HTML文档插入到父文档中。了解iframe如何工作以便可以有效使用非常重要。

- ``<iframe> ``优点：

  - 像徽章和广告等缓慢的第三方内容
  - 安全沙箱
  - 并行下载脚本
- ``<iframe> ``缺点：

  - 即使空白也很昂贵
  - 阻止页面载入
  - 非语义  
  
禁止使用iframe引入外部资源，不包括allyes广告，不包括about:blank的空页面。

## 等待响应
### `8. 优化规则 – 避免重定向` 
  
  以下是一个重定向的过程： 
  
  浏览器发送请求——>服务器返回302——>浏览器发送第二次请求—–>服务器返回200—>浏览器开始呈现 
  
  就是说，在重定向完毕并且HTML下载完毕之前，是没有任何东西显示给用户  
  
  要记住的重点是`重定向会减慢用户体验`。在用户和HTML文档之间插入重定向会延迟页面中的所有内容，因为可以呈现页面中的任何内容，并且在HTML文档到达之前不会开始下载任何组件。  

  涉及服务器负载、数据查询、服务器端缓存等

## 接收数据
### `9. 优化规则 – 压缩组件Gzip `
  - HTML文档、脚本和样式表、XML和JSON的文本响应,压缩通常能将响应的数据量减少将近70%  

  - 大多数网站gzip他们的HTML文件。gzip脚本和样式表也是值得的，但很多网站都错过了这个机会。事实上，压缩包括XML和JSON的任何文本响应都是值得的。  
  
  - 图像和PDF文件不应该被压缩，因为它们已经被压缩。试图压缩它们不仅浪费CPU，而且可能会增加文件大小。

### `10. 优化规则 – 精简Javascript和CSS文件大小 `
- 从代码中移除不必要的字符以减少其大小，减少加载时间。

- 减少JavaScript 文件大小的有几种手段:  
  - 精简:去除JavaScript代码中的空格、注释等多余的字符，这种方式基本上没有什么缺点。

  - 混淆:在精简的基础上，把函数、变量名都用较短小的字符来替换，从而达到减少文件大小的效果。
  - 但是混淆会产生不少麻烦，很有可能会引入错误，虽然有利于防止逆向工程，当同时也增加了自己在线上环境调试的难度。 
  - 现在普遍的做法是发布前利用 Gulp、Grunt等自动化构建工具对资源进行压缩。  

### `11. 优化规则 – 尽量缩减页面大小 `
  
  - 页面必须小于150K(不含图片）

  - 静态文件是否gzip
  - 图片是否压缩优化过

## 读取Cache

### `12. 优化规则 – 添加 Expires 头或 Cache-Control `
  - Expires头是用来告诉浏览器该响应的有效期，可以理解为该资源的“保质期”，在期限内可以使用该资源的缓存不需要重新请求。

  - 由于浏览器与服务器存在时钟同步问题，HTTP1.2.1还添加了Cache-Control和max-age来弥补Expires头的不足。
  - 通常用于脚本、样式表、图片等静态资源。

使用这种策略可能会遇到一个问题是，开发者可能想要在资源过期前这段时间更新它们。 

这时候，由于浏览器的缓存还没失效，这就需要通过更改文件名来令静态资源 强制失效。有很多种方式给静态资源打上版本号，可以一本正经地打上数字版本号，根据内容生成哈希码也行，甚至有人用π来给自己的资源打版本号.  

应用于不经常变化的组件，包括脚本、样式表、Flash组件、图片

### `13. 优化规则 – 使用外链JavaScript和CSS `
  
  - 尽可能 使用外链JavaScript和CSS，因为我们目前大部分avaScript和CSS都做了Gzip和缓存技术，可以充分利用。

- 使用外链样式和脚本优点有： 
   - 可以被浏览器缓存起来；
   - 组件可重用
   - 可模块化；
   - 能够被构建（合并压缩打版本）

- 内联的JavaScript和CSS: 减少HTTP请求数量，增加了HTML文档的大小。
- JavaScript和CSS位于浏览器：缓存的外部文件中：HTML文档的大小会减少，不会增加HTTP请求的数量。

>关键因素是外部JavaScript和CSS组件相对于所请求HTML文档数量的缓存频率。这个因素尽管难以量化，但可以使用各种指标进行衡量。如果您的网站上的用户每个会话有多个页面浏览量，并且许多网页重复使用相同的脚本和样式表，则缓存的外部文件可能带来更大的潜在收益。

## 处理元素  
不要对image和pdf等二进制文件进行gzip压缩

## 渲染元素
### `14. 优化规则 – 将样式表放在顶部 `
  
  - 样式表放在底部时，浏览器会延迟显示任何可视化组件(使用 CSS 的@import 等同于把想要加载的样式放在底部，所以不建议使用。)  

  - 对于浏览器的渲染机制，本书并没有过多提及，只是对现象做出了描述以及提供了解决办法.  

  - 如果样式表仍然在加载，构建呈现树就是一种浪费，因为在所有样式表 加载并解析完毕 之前无需绘制任何东西。因为在样式表准备好之前显示内容会遇到 FOUC（无样式内容的闪烁，Flash of Unstyled Content）问题。  
  - 样式表不在顶部中，当遇到样式时，浏览器就会阻止页面呈现，等待样式表下载完毕。如果把样式表放在底部，在 IE 中还会产生白屏现象。
  - 总之，把样式表放进就能避免这些问题。

### `15. 优化规则 – 建议将脚本放在底部 `
  
  一般浏览器可以允许并行下载，取决于主机个数、带宽等（默认情况下，IE是2个而FF是8个）下载脚本时并行下载实际上是被禁用的。

- 脚本对页面的影响是：
  - 阻塞对其后面内容的呈现
  - 阻塞后面组件的下载
  - 浏览器会在下载脚本的时候阻塞并行下载，因为需要确保脚本能够顺序执行。
  >但是，实际开发中有时候很难完全遵守这条准则，那只能把能够放在最后的都放在最后。

### `16. 优化规则 – 移除重复脚本` 
  
  必须为0，重复的脚本对增加HTTP 请求次数和脚本执行的时间。

### `17. 优化规则 – 避免CSS表达式 `
  
  使用CSS 的expression()通常会造成多次运算。影响浏览器渲染时间。实际上，需要用到CSS表达式的地方，通常能够找到其他替代方案，所以避免使用CSS表达式。

### `18. 优化规则 – 优化图像 `
  - 尽量使用GIF和PNG

  - 尽量使用png/gif格式的图片，png的图片优先，但是必须注意如要兼容IE6，则png使用一定要注意透明问题。

  - 图片在使用前一定要先用工具压缩优化（png、jpg）

