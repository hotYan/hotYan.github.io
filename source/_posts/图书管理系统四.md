---
title: 图书管理系统四
date: 2018-06-19 23:49:33
tags: 图书管理系统
categories: Express+ejs+Mysql图书管理系统
---
## 实现具体功能 <span style="font-size:.5em">[待更新]</span>
>所有的功能实现都在写在这里了。

<!--more-->

## 链接自取
>个人比较喜欢先甩参考链接,可以选择直接去看参考链接。
>- [参考教程1](http://www.alloyteam.com/2015/03/sexpressmysql/)
>- [参考教程2](https://www.xiabingbao.com/node/2017/02/20/node-express-forum.html)(划重点!) 

【注意】虽然前期看了教程1之后，功能没有实现，但是给教程2奠定一定的知识储备,建议都看看。  


----
## 一、你可能必须先看一下以下教程
仔细看看[Node.js开发框架Express4.x](http://blog.fens.me/nodejs-express4/) 下的以下部分
   
        2. 目录结构
        3. package.json项目配置
        4. app.js核心文件
        5.Bootstrap界面框架(选看,里面涉及到的重复代码前面讲过)
        6. 路由功能
    
## 二、跟着[参考教程2](https://www.xiabingbao.com/node/2017/02/20/node-express-forum.html)完成注册/登录
        看了很多网上的教程吧,只有教程2让我成功了,作者写的也非常用心超级仔细！！！！我只跟着敲了用户注册登录,其他就无师自通啦~

## 三、写在后面

        看了所有推荐的链接,基本上就没有什么问题啦。知识本身不难,难得是我们要在网上找到靠谱的教程。

## 四、根据项目记录下一些具体的细节
>### 保持用户登录状态(app.js)

- 加载依赖库  

        var cookieParser = require('cookie-parser');  
        var session = require('express-session');
- 定义cookie解析器

        app.use(cookieParser());
        app.use(session({
            secret: 'hotyan',  // 用来对session id相关的cookie进行签名
            saveUninitialized: true,  // 是否自动保存未初始化的会话，建议false
            resave: false,  // 是否每次都重新保存会话，建议false
            cookie: {maxAge:  60*60 * 1000 } // 有效期，单位是毫秒
        }))


- 在app.js文件下添加自定义中间件,实现保持用户登录状态

        app.use(function(req, res, next){
            // 如果session中存在，则说明已经登录
            if( req.session.hotyan ){
                res.locals.hotyan = {
                    UserId : req.session.hotyan.UserId,
                    UserName : req.session.hotyan.UserName
                }
            }else{
                res.locals.hotyan = {};
            }
            next();//此处必须有
        })

>### 数据库连接(models/db.js)  

        var mysql = require('mysql');
        var pool = mysql.createPool({
            host: 'localhost',
            user: 'root',
            password: 'XXXXXX',
            database: 'XXXXXX'
        });
        module.exports = pool;  



>### Mysql语句(方法总结于教程2)  

以对图书管理员进行增删改查为例,新建(SQL/adminSql.js)文件,将需要的Mysql语句全部独立出来。

        //对bookadmin进行增删改查
        var admin = {
            /**添加图书管理员 */
            insert :'INSERT INTO `bookadmin` SET `BAId`=?, `BAName`=? ,`BAPassword`=?,`BAPhone`=?,`BAEmail`=?',
            /**修改图书管理员信息 */
            update : 'UPDATE `bookadmin` SET `BAName`=? ,`BAPhone`=?,`BAEmail`=? WHERE `BAId`=?',
            /**删除图书管理员 */
            delete: 'DELETE FROM `bookadmin` WHERE `BAId`=?',
            /**精确查看图书管理员信息 */
            queryById : 'SELECT * FROM `bookadmin` WHERE `BAId`=?',
            /**查看全部图书管理员信息 */
            queryAll : 'SELECT * FROM `bookadmin` '
        };
        module.exports = admin;


>### 实现功能的函数放置在(models/users.js)  

- 1、加载依赖文件

        var pool = require('./db'), // 连接数据库
            admin = require('../SQL/adminSql'),//图书管理员的Mysql语句
            crypto = require('crypto'); // 对密码进行加密


- 2、以添加图书管理员为例学习如何使用封装的函数

        adminadd: function (BAId, BAName, BAPassword, BAPhone, BAEmail, cb) {
                pool.getConnection(function (err, connection) {
                    if (err) throw err;
                    connection.query(admin.insert, [BAId, BAName, BAPassword, BAPhone, BAEmail], function (err, result) {
                        if (err) throw err;
                        cb(result);
                        connection.release();
                    })
                })
            }

    注意:建议了解一下query()方法,参数可2可3,query(mysql语句,内容数组,回调函数）;我把Mysql语句独立了出去,看了教程2就知道。  

>### 表单提交POST请求   

 以添加图书管理员为例

        <form action="/badAddAdmin" method="POST" class="ad_data">//注意1
            <div class="data">
                <label>管理号</label>
                <input type="text" placeholder="输入图书管理员编号" name="BAId" />//注意2
            </div>   
            ...     
            <div class="data">
                <label>邮箱</label>
                <input type="text" placeholder="输入图书管理员邮箱" name="BAEmail" />
            </div>
            <input class="add_btn" type="submit" value="确认添加" />//注意3    
        </form>

注意三个地方: 
        
        1.action="/badAddAdmin" method="POST"  
        2.name="BAId"
        3.type="submit"

>### 在(routes/index.js)中添加POST代码

以添加图书管理员界面为例:

        router.post('/badAddAdmin', function (req, res, next) {
            /*获取表单传来的数据*/
            var BAId = req.body.BAId || '',
                BAName = req.body.BAName || '',
                BAPassword = req.body.BAPassword || '',
                BAPhone = req.body.BAPhone || '',
                BAEmail = req.body.BAEmail || '';
            /*调用密码加密函数*/
            var password_hash = user_m.hash(BAPassword);
            /*调用添加图书管理员函数*/
            user_m.adminadd(BAId, BAName, password_hash, BAPhone, BAEmail, function (result) {
                console.log("添加成功");
                res.redirect('/badAddAdmin');
            })
        })

>### ejs循环渲染(查看界面需要)
 
        /*(routes/index.js)中代码*/
        router.post('/badCheckAdmin', function (req, res, next) {
            console.log(req.body);
            var BAId = req.body.BAId;
            user_m.adminId(BAId, function (result) {
                console.log("精确查看成功");
                res.render('badCheckAdmin', {
                    title: '查看图书管理员信息',
                    datas: result     //返回json数据,
                })
            })
        });
【注意】返回json数据,需要依赖模块body-parser,此处建议了解一下res.render()  


        /*(views/badCheckAdmin.ejs)中渲染代码*/
        <tbody>
            <% for(var i=0;i< datas.length;i++){ %>
            <tr>
                <td >
                <%= datas[i].BAId %>
                </td>
                <td>
                <%= datas[i].BAName %>
                </td>
                <td>
                <%= datas[i].BAPhone %>
                </td>
                <td>
                <%= datas[i].BAEmail %>
                </td>
            </tr>
            <% }%>
        </tbody>
      
    
>### 日期格式YYYY-MM-DD    
在(routes/index.js)文件中

        /*加载依赖模块*/
        var time = require('silly-datetime')

        /*在需要的地方使用,以注册时间为例*/
        RegTime = time.format(new Date(), 'YYYY-MM-DD');
            
>### 图书应该归还日期(30天后)

        /******在(models/users.js)中添加date方法*******/
        date: function (AddDay) {
            var date = new Date();

                /*****获取AddDay天后的日期 ********/
                date.setDate(date.getDate() + AddDay);

            var Y = date.getFullYear(),
                    /***** 获取当前月份的日期，不足10补0 *****/
                M = (date.getMonth() + 1) < 10 ? "0" + (date.getMonth() + 1) : (date.getMonth() + 1),
                    /****获取当前几号，不足10补0  ****/
                D = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();

            return Y + "-" + M + "-" + D;
        }

        /*******在(routes/index.js)借书界面调用date方法********/
        var ShouldTime = user_m.date(30);